layout: default
<div class="note-page">
  <article class="post-single">
    <header class="post-header">
      <h1 class="post-title">{{ page.title }}</h1>
      {% assign updated = page.last_modified_at | default: page.date %}
      {% if updated %}
      <div class="post-meta">
        <span title="{{ updated | date_to_xmlschema }}">{{ updated | date: '%B %-d, %Y' }}</span>
      </div>
      {% endif %}
      {% if page.tags %}
      <div class="post-meta post-meta__categories">
        Categories:
        {% for tag in page.tags %}
        <span>{{ tag }}</span>{% unless forloop.last %}, {% endunless %}
        {% endfor %}
      </div>
      {% endif %}
    </header>
    <div class="toc" id="note-toc">
      <details open>
        <summary accesskey="c" title="(Alt + C)">
          <span class="details">Table of Contents</span>
        </summary>
        <div class="inner">
          <ul id="note-toc-list"></ul>
        </div>
      </details>
    </div>
    <div class="post-content" id="post-content">
      {{ content }}
    </div>
  </article>
</div>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const content = document.getElementById("post-content");
    const toc = document.getElementById("note-toc");
    const list = document.getElementById("note-toc-list");
    if (!content || !toc || !list) {
      return;
    }

    const headings = [...content.querySelectorAll("h1, h2, h3")];
    if (!headings.length) {
      toc.style.display = "none";
      return;
    }

    const createSlug = (text) =>
      text
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\s-]/g, "")
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-");

    const root = document.createElement("ul");
    root.id = "note-toc-list";
    const current = {
      1: null,
      2: null,
      3: null
    };

    headings.forEach((heading) => {
      const level = parseInt(heading.tagName.replace("H", ""), 10);
      const text = heading.textContent.trim();
      if (!text) {
        return;
      }

      const normalizedLevel = Math.min(Math.max(level, 1), 3);

      if (!heading.id) {
        let slug = createSlug(text);
        let uniqueSlug = slug;
        let index = 1;
        while (document.getElementById(uniqueSlug)) {
          uniqueSlug = `${slug}-${index++}`;
        }
        heading.id = uniqueSlug || `section-${index}`;
      }

      if (!heading.querySelector(".anchor")) {
        const anchor = document.createElement("a");
        anchor.href = `#${heading.id}`;
        anchor.className = "anchor";
        anchor.setAttribute("aria-hidden", "true");
        anchor.textContent = "#";
        heading.appendChild(anchor);
      }

      let effectiveLevel = normalizedLevel;
      const item = document.createElement("li");
      const link = document.createElement("a");
      link.href = `#${heading.id}`;
      link.textContent = text;
      item.appendChild(link);

      if (normalizedLevel === 1 || (!current[1] && normalizedLevel > 1)) {
        effectiveLevel = 1;
        item.className = "toc-level-1";
        root.appendChild(item);
        current[1] = item;
        current[2] = null;
        current[3] = null;
      } else if (normalizedLevel === 2 || (!current[2] && normalizedLevel > 2)) {
        if (!current[1]) {
          effectiveLevel = 1;
          item.className = "toc-level-1";
          root.appendChild(item);
          current[1] = item;
          current[2] = null;
          current[3] = null;
          return;
        }
        effectiveLevel = 2;
        item.className = "toc-level-2";
        const parent = current[1] || root;
        let container = parent.querySelector("ul");
        if (!container) {
          container = document.createElement("ul");
          parent.appendChild(container);
        }
        container.appendChild(item);
        current[2] = item;
        current[3] = null;
      } else {
        if (!current[2]) {
          effectiveLevel = current[1] ? 2 : 1;
          item.className = `toc-level-${effectiveLevel}`;
          const parentFallback = current[1] || root;
          let containerFallback = parentFallback.querySelector("ul");
          if (!containerFallback) {
            containerFallback = document.createElement("ul");
            parentFallback.appendChild(containerFallback);
          }
          containerFallback.appendChild(item);
          if (effectiveLevel === 2) {
            current[2] = item;
          } else {
            current[1] = item;
            current[2] = null;
          }
          current[3] = item;
          return;
        }
        effectiveLevel = 3;
        item.className = "toc-level-3";
        const parent = current[2] || current[1] || root;
        let container = parent.querySelector("ul");
        if (!container) {
          container = document.createElement("ul");
          parent.appendChild(container);
        }
        container.appendChild(item);
        current[3] = item;
      }
    });

    list.replaceWith(root);
  });
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (window.renderMathInElement) {
      window.renderMathInElement(document.getElementById("post-content"), {
        delimiters: [
          { left: "$$", right: "$$", display: true },
          { left: "\\[", right: "\\]", display: true },
          { left: "$", right: "$", display: false },
          { left: "\\(", right: "\\)", display: false }
        ],
        throwOnError: false
      });
    }
  });
</script>
